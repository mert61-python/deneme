#include <ESP8266WiFi.h>
#include <WiFiUdp.h>
#include <Wire.h>
#include <Adafruit_MLX90393.h>
#include <Adafruit_MLX90614.h>
#include <ArduinoJson.h>
#include <ArduinoOTA.h>
#include <ESP8266WebServer.h>

// â€”â€”â€”â€”â€”â€”â€” CONFIG â€”â€”â€”â€”â€”â€”â€”
#define COIL_ID 1
const char* WIFI_SSID = "Mert's Galaxy S23 Ultra";
const char* WIFI_PSWD = "mert1903.";

// Sabit IP AyarlarÄ±
IPAddress staticIP(192, 168, 152, 200);  // ESP iÃ§in sabit IP adresi
IPAddress gateway(192, 168, 152, 178);   // AÄŸ geÃ§idi (router) IP adresi
IPAddress subnet(255, 255, 255, 0);      // Alt aÄŸ maskesi
IPAddress dns(8, 8, 8, 8);               // DNS sunucusu (Google DNS)

// UDP AyarlarÄ± - Ä°ki ayrÄ± port kullanÄ±mÄ±
WiFiUDP udpSensor;  // SensÃ¶r verilerini gÃ¶ndermek iÃ§in
WiFiUDP udpPWM;     // PWM komutlarÄ±nÄ± almak iÃ§in
const char* guiIP = "192.168.152.194";  // GUI bilgisayarÄ±nÄ±n IP adresi (kullanÄ±cÄ±nÄ±n IP'si)
const int sensorPort = 4210;  // SensÃ¶r verilerini GUI'ye gÃ¶nderme portu
const int pwmPort = 4211;     // PWM komutlarÄ±nÄ± alma portu

// Web Sunucu AyarlarÄ±
ESP8266WebServer server(80);  // HTTP sunucu portu 80
bool webServerActive = false;
unsigned long lastWebUpdate = 0;
const unsigned long webUpdateInterval = 500; // Web arayÃ¼zÃ¼ gÃ¼ncelleme aralÄ±ÄŸÄ± (ms)

// I2C Pinleri - NodeMCU standart I2C pinleri
const int SDA_PIN = D2;  // GPIO4 (NodeMCU D2)
const int SCL_PIN = D1;  // GPIO5 (NodeMCU D1)

// GUI Uyumlu PWM Kontrol Sistemi
const int GUI_PWM_PIN = D5;  // GPIO14 (NodeMCU D5 pini)
const int GUI_PWM_RANGE = 1023;  // ESP8266 PWM range (0-1023)
bool gui_pwm_active = false;
int gui_pwm_frequency = 0;
float gui_pwm_duty = 0.0;

// SensÃ¶r nesneleri
Adafruit_MLX90393 mlx90393 = Adafruit_MLX90393();
Adafruit_MLX90614 mlx90614 = Adafruit_MLX90614();

// Timing ayarlarÄ± - Optimize edilmiÅŸ hÄ±z ayarlarÄ±
unsigned long lastSensorRead = 0;
unsigned long lastTempRead = 0;
unsigned long lastUDPSend = 0;
const unsigned long magneticInterval = 25;   // 25ms = 40Hz (manyetik alan iÃ§in daha hÄ±zlÄ±)
const unsigned long tempInterval = 500;     // 500ms = 2Hz (sÄ±caklÄ±k yavaÅŸ deÄŸiÅŸir)
const unsigned long udpInterval = 25;       // 10ms = 100Hz (GUI iÃ§in daha anlÄ±k)

// WiFi deÄŸiÅŸkenleri
int wifiStrength = 0;

// SensÃ¶r durumlarÄ±
bool mlx90393_ready = false;
bool mlx90614_ready = false;

// Manyetik alan dÃ¶nÃ¼ÅŸÃ¼m faktÃ¶rÃ¼
const float UT_TO_MT = 1000.0;

// MANYETIK ALAN FILTRELEME SISTEMI KALDIRILDI
// DoÄŸrudan Ã¶lÃ§Ã¼m deÄŸerleri kullanÄ±lacak

// Cached sensor values
float cached_magnetic_magnitude = 0.0;
float cached_ambient_temp = -999.0;
float cached_object_temp = -999.0;

// Performance monitoring
unsigned long lastReport = 0;
unsigned long packetCount = 0;
unsigned long totalBytes = 0;
unsigned long failedReads = 0;

// JSON document - ESP8266 iÃ§in daha kÃ¼Ã§Ã¼k
StaticJsonDocument<200> doc;
char jsonBuffer[256];

// GeliÅŸmiÅŸ I2C device kontrol fonksiyonu
bool checkI2CDevice(uint8_t address, int retries = 3) {
  for (int i = 0; i < retries; i++) {
    Wire.beginTransmission(address);
    uint8_t error = Wire.endTransmission();
    if (error == 0) {
      return true;
    }
    delay(100); // Her deneme arasÄ±nda bekleme
  }
  return false;
}

void scanI2CDevices() {
  Serial.println("\n=== DETAYLI I2C SENSÃ–R TARAMASI ===");
  bool deviceFound = false;
  
  for (uint8_t addr = 1; addr < 127; addr++) {
    if (checkI2CDevice(addr, 1)) {
      Serial.printf("âœ“ I2C cihaz bulundu: 0x%02X", addr);
      
      // Bilinen cihazlarÄ± tanÄ±
      if (addr == 0x18) Serial.print(" (MLX90393 - Manyetik SensÃ¶r)");
      if (addr == 0x5A) Serial.print(" (MLX90614 - SÄ±caklÄ±k SensÃ¶rÃ¼)");
      
      Serial.println();
      deviceFound = true;
    }
  }
  
  if (!deviceFound) {
    Serial.println("âœ— HiÃ§bir I2C cihaz bulunamadÄ±!");
    Serial.println("BaÄŸlantÄ±larÄ± ve pull-up direnÃ§lerini kontrol edin.");
  }
  
  Serial.println("=====================================\n");
}

// I2C'yi gÃ¼venli ÅŸekilde yeniden baÅŸlat - ESP8266 versiyonu
void restartI2C() {
  Serial.println("I2C yeniden baÅŸlatÄ±lÄ±yor...");
  // ESP8266'da Wire.end() yok, doÄŸrudan yeniden baÅŸlat
  delay(500);
  Wire.begin(SDA_PIN, SCL_PIN);
  Wire.setClock(100000); // Sabit 100kHz hÄ±z
  delay(500);
}

// Dosya sistemi iÅŸlevleri
void initFileSystem() {
  // ArtÄ±k dosya sistemi kullanmÄ±yoruz, HTML kod iÃ§inde gÃ¶mÃ¼lÃ¼
  Serial.println("âœ“ Web arayÃ¼zÃ¼ HTML iÃ§inde gÃ¶mÃ¼lÃ¼ olarak hazÄ±r");
}

// Web sunucu iÅŸlevleri
void handleRoot() {
  String html = R"rawliteral(
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP8266 SensÃ¶r Kontrol Paneli</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container { 
            max-width: 1200px; margin: 0 auto; 
            background: rgba(25, 42, 86, 0.9); 
            border-radius: 20px; padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            color: #ffffff;
        }
        .header { 
            text-align: center; margin-bottom: 30px; 
            border-bottom: 3px solid #00bcd4; padding-bottom: 20px;
        }
        .header h1 { 
            color: #00bcd4; font-size: 2.5em; margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 188, 212, 0.3);
        }
        .status { 
            display: inline-block; padding: 8px 16px; 
            background: #4CAF50; color: white; 
            border-radius: 20px; font-weight: bold;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; margin-bottom: 30px;
        }
        .card { 
            background: rgba(35, 52, 96, 0.9); border-radius: 15px; 
            padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-left: 5px solid #00bcd4; transition: all 0.3s ease;
            color: #ffffff;
        }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0, 188, 212, 0.3);
        }
        .card h3 { 
            color: #00bcd4; margin-bottom: 15px; 
            font-size: 1.4em; display: flex; align-items: center;
            text-shadow: 0 2px 5px rgba(0, 188, 212, 0.2);
        }
        .sensor-value { 
            font-size: 2.2em; font-weight: bold; 
            color: #ffffff; margin: 10px 0;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .sensor-unit { 
            font-size: 0.9em; color: #b3e5fc; 
            margin-left: 5px;
        }
        .pwm-controls { 
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            border-left-color: #fdbb2d;
        }
        .input-group { 
            margin: 15px 0; display: flex; 
            align-items: center; gap: 10px;
        }
        .input-group label { 
            min-width: 80px; font-weight: bold; 
            color: #ffffff;
        }
        .input-group input { 
            flex: 1; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); 
            border-radius: 8px; font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(35, 52, 96, 0.8);
            color: #ffffff;
        }
        .input-group input:focus { 
            outline: none; border-color: #00bcd4; 
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        }
        .btn { 
            padding: 12px 25px; border: none; 
            border-radius: 8px; cursor: pointer; 
            font-size: 16px; font-weight: bold; 
            transition: all 0.3s ease; margin: 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .btn-primary { 
            background: #00bcd4; color: white; 
        }
        .btn-primary:hover { 
            background: #00acc1; transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.5);
        }
        .btn-success { 
            background: #4CAF50; color: white; 
        }
        .btn-success:hover { 
            background: #43a047; transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.5);
        }
        .btn-danger { 
            background: #f44336; color: white; 
        }
        .btn-danger:hover { 
            background: #e53935; transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.5);
        }
        .status-indicator { 
            display: inline-block; width: 12px; height: 12px; 
            border-radius: 50%; margin-right: 8px;
            box-shadow: 0 0 10px currentColor;
        }
        .status-active { background: #4CAF50; box-shadow: 0 0 10px #4CAF50; }
        .status-inactive { background: #f44336; box-shadow: 0 0 10px #f44336; }
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-top: 20px;
        }
        .info-item { 
            background: rgba(25, 42, 86, 0.7); padding: 15px; 
            border-radius: 10px; text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 188, 212, 0.2);
            transition: all 0.3s ease;
        }
        .info-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.3);
            border-color: rgba(0, 188, 212, 0.5);
        }
        .info-label { 
            font-size: 0.9em; color: #b3e5fc; 
            margin-bottom: 5px;
        }
        .info-value { 
            font-size: 1.2em; font-weight: bold; 
            color: #ffffff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        /* Animasyonlar */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(0, 188, 212, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 188, 212, 0.8); }
            100% { box-shadow: 0 0 5px rgba(0, 188, 212, 0.5); }
        }
        
        /* Animasyonlu elementler */
        .sensor-value {
            animation: pulse 2s infinite ease-in-out;
        }
        
        .status-active {
            animation: glow 2s infinite ease-in-out;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container { 
                padding: 15px; 
                margin: 10px;
                width: calc(100% - 20px);
            }
            .header h1 { font-size: 2em; }
            .grid { grid-template-columns: 1fr; }
            .input-group { 
                flex-direction: column; 
                align-items: stretch; 
                margin: 20px 0;
            }
            .input-group label { min-width: auto; margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ ESP8266 SensÃ¶r Kontrol Paneli</h1>
            <div class="status" id="connectionStatus">BaÄŸlanÄ±yor...</div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>âš¡ Manyetik Alan SensÃ¶rÃ¼</h3>
                <div class="sensor-value" id="magneticValue">--</div>
                <div class="sensor-unit">mT (miliTesla)</div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Durum</div>
                        <div class="info-value" id="magneticStatus">Bekleniyor</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ”¥ SÄ±caklÄ±k SensÃ¶rÃ¼</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <div class="info-label">Ortam SÄ±caklÄ±ÄŸÄ±</div>
                        <div class="sensor-value" id="ambientTemp">--</div>
                        <div class="sensor-unit">Â°C</div>
                    </div>
                    <div>
                        <div class="info-label">Nesne SÄ±caklÄ±ÄŸÄ±</div>
                        <div class="sensor-value" id="objectTemp">--</div>
                        <div class="sensor-unit">Â°C</div>
                    </div>
                </div>
            </div>
            
            <div class="card pwm-controls">
                <h3>ğŸ›ï¸ PWM Kontrol</h3>
                <div class="info-item" style="margin-bottom: 20px;">
                    <span class="status-indicator" id="pwmStatusIndicator"></span>
                    <span id="pwmStatusText">PWM KapalÄ±</span>
                </div>
                
                <div class="input-group">
                    <label>Frekans:</label>
                    <input type="number" id="frequencyInput" min="1" max="1000" value="100" placeholder="1-1000 Hz">
                    <span style="color: #666;">Hz</span>
                </div>
                
                <div class="input-group">
                    <label>Duty:</label>
                    <input type="number" id="dutyInput" min="0" max="100" step="0.1" value="50" placeholder="0-100%">
                    <span style="color: #666;">%</span>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="applyPWMSettings()">âœ… AyarlarÄ± Uygula</button>
                    <button class="btn btn-primary" onclick="startPWM()">â–¶ PWM BaÅŸlat</button>
                    <button class="btn btn-danger" onclick="stopPWM()">â¹ PWM Durdur</button>
                </div>
                
                <div class="info-grid" style="margin-top: 20px;">
                    <div class="info-item">
                        <div class="info-label">Aktif Frekans</div>
                        <div class="info-value" id="activePWMFreq">-- Hz</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Aktif Duty</div>
                        <div class="info-value" id="activePWMDuty">-- %</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ“¡ Sistem Bilgileri</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Coil ID</div>
                    <div class="info-value" id="coilId">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">WiFi Sinyal</div>
                    <div class="info-value" id="wifiSignal">-- dBm</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ã‡alÄ±ÅŸma SÃ¼resi</div>
                    <div class="info-value" id="uptime">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Son GÃ¼ncelleme</div>
                    <div class="info-value" id="lastUpdate">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval;
        let startTime = Date.now();
        
        function updateSensorData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    // BaÄŸlantÄ± durumu
                    document.getElementById('connectionStatus').textContent = 'BaÄŸlÄ± âœ…';
                    document.getElementById('connectionStatus').style.background = '#4CAF50';
                    
                    // Manyetik alan
                    document.getElementById('magneticValue').textContent = 
                        data.magnetic_magnitude ? data.magnetic_magnitude.toFixed(3) : '--';
                    document.getElementById('magneticStatus').textContent = 
                        data.magnetic_magnitude ? 'Aktif' : 'Veri Yok';
                    
                    // SÄ±caklÄ±k
                    document.getElementById('ambientTemp').textContent = 
                        data.ambient_temp ? data.ambient_temp.toFixed(1) : '--';
                    document.getElementById('objectTemp').textContent = 
                        data.object_temp ? data.object_temp.toFixed(1) : '--';
                    
                    // PWM durumu
                    const pwmActive = data.gui_pwm_active;
                    const indicator = document.getElementById('pwmStatusIndicator');
                    const statusText = document.getElementById('pwmStatusText');
                    
                    if (pwmActive) {
                        indicator.className = 'status-indicator status-active';
                        statusText.textContent = 'PWM Aktif';
                    } else {
                        indicator.className = 'status-indicator status-inactive';
                        statusText.textContent = 'PWM KapalÄ±';
                    }
                    
                    // PWM deÄŸerlerini gÃ¼ncelle ve input alanlarÄ±nÄ± da gÃ¼ncelle
                    document.getElementById('activePWMFreq').textContent = 
                        data.gui_pwm_frequency + ' Hz';
                    document.getElementById('activePWMDuty').textContent = 
                        data.gui_pwm_duty + ' %';
                    
                    // Input alanlarÄ±nÄ± da gÃ¼ncelle
                    document.getElementById('frequencyInput').value = data.gui_pwm_frequency;
                    document.getElementById('dutyInput').value = data.gui_pwm_duty;
                    
                    // Sistem bilgileri
                    document.getElementById('coilId').textContent = data.coil_id || '--';
                    document.getElementById('wifiSignal').textContent = 
                        data.wifi_rssi ? data.wifi_rssi + ' dBm' : '--';
                    
                    // Ã‡alÄ±ÅŸma sÃ¼resi
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = uptime % 60;
                    document.getElementById('uptime').textContent = 
                        hours.toString().padStart(2,'0') + ':' + minutes.toString().padStart(2,'0') + ':' + seconds.toString().padStart(2,'0');
                    
                    // Son gÃ¼ncelleme
                    document.getElementById('lastUpdate').textContent = 
                        new Date().toLocaleTimeString('tr-TR');
                })
                .catch(error => {
                    console.error('Veri alÄ±namadÄ±:', error);
                    document.getElementById('connectionStatus').textContent = 'BaÄŸlantÄ± HatasÄ± âŒ';
                    document.getElementById('connectionStatus').style.background = '#f44336';
                });
        }
        
        function applyPWMSettings() {
            const frequency = document.getElementById('frequencyInput').value;
            const duty = document.getElementById('dutyInput').value;
            
            if (!frequency || !duty) {
                alert('LÃ¼tfen frekans ve duty deÄŸerlerini girin!');
                return;
            }
            
            if (frequency < 1 || frequency > 1000) {
                alert('Frekans 1-1000 Hz arasÄ±nda olmalÄ±dÄ±r!');
                return;
            }
            
            if (duty < 0 || duty > 100) {
                alert('Duty cycle 0-100% arasÄ±nda olmalÄ±dÄ±r!');
                return;
            }
            
            fetch('/pwm?frequency=' + frequency + '&duty=' + duty)
                .then(response => response.text())
                .then(data => {
                    alert('PWM ayarlarÄ± gÃ¼ncellendi: ' + data);
                    updateSensorData();
                })
                .catch(error => {
                    alert('PWM ayarlarÄ± gÃ¼ncellenemedi: ' + error);
                });
        }
        
        function startPWM() {
            fetch('/pwm?start=1')
                .then(response => response.text())
                .then(data => {
                    alert('PWM baÅŸlatÄ±ldÄ±: ' + data);
                    updateSensorData();
                })
                .catch(error => {
                    alert('PWM baÅŸlatÄ±lamadÄ±: ' + error);
                });
        }
        
        function stopPWM() {
            fetch('/pwm?stop=1')
                .then(response => response.text())
                .then(data => {
                    alert('PWM durduruldu: ' + data);
                    updateSensorData();
                })
                .catch(error => {
                    alert('PWM durdurulamadÄ±: ' + error);
                });
        }
        
        // Sayfa yÃ¼klendiÄŸinde baÅŸlat
        window.onload = function() {
            updateSensorData();
            updateInterval = setInterval(updateSensorData, 1000);
        };
        
        // Sayfa kapatÄ±lÄ±rken temizle
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
</body>
</html>
)rawliteral";
  
  server.send(200, "text/html", html);
}

void handleCSS() {
  // CSS artÄ±k HTML iÃ§inde gÃ¶mÃ¼lÃ¼ olduÄŸu iÃ§in bu fonksiyon gereksiz
  server.send(404, "text/plain", "CSS dosyasÄ± artÄ±k HTML iÃ§inde gÃ¶mÃ¼lÃ¼!");
}

void handleJS() {
  // JavaScript artÄ±k HTML iÃ§inde gÃ¶mÃ¼lÃ¼ olduÄŸu iÃ§in bu fonksiyon gereksiz
  server.send(404, "text/plain", "JavaScript dosyasÄ± artÄ±k HTML iÃ§inde gÃ¶mÃ¼lÃ¼!");
}

void handleNotFound() {
  server.send(404, "text/plain", "Sayfa bulunamadÄ±!");
}

void handleSensorData() {
  // JSON belgesini oluÅŸtur
  StaticJsonDocument<200> webDoc;
  webDoc["timestamp"] = millis();
  webDoc["coil_id"] = COIL_ID;
  webDoc["magnetic_magnitude"] = cached_magnetic_magnitude;
  webDoc["ambient_temp"] = cached_ambient_temp != -999.0 ? cached_ambient_temp : 0;
  webDoc["object_temp"] = cached_object_temp != -999.0 ? cached_object_temp : 0;
  webDoc["gui_pwm_active"] = gui_pwm_active;
  webDoc["gui_pwm_frequency"] = gui_pwm_frequency;
  webDoc["gui_pwm_duty"] = gui_pwm_duty;
  webDoc["wifi_rssi"] = wifiStrength;
  
  // Debug: JSON'da gÃ¶nderilen duty deÄŸerini logla
  Serial.printf("JSON'da gÃ¶nderilen duty deÄŸeri: %.2f%%\n", gui_pwm_duty);
  
  // JSON'Ä± string olarak gÃ¶nder
  String jsonString;
  serializeJson(webDoc, jsonString);
  server.send(200, "application/json", jsonString);
}

void handlePWMControl() {
  String message = "PWM ayarlarÄ± gÃ¼ncellendi";
  bool updatePWM = false;
  
  if (server.hasArg("start")) {
    gui_pwm_active = true;
    updatePWM = true;
    message = "PWM baÅŸlatÄ±ldÄ±";
    Serial.printf("PWM baÅŸlatma komutu alÄ±ndÄ± - Mevcut ayarlar: Frekans=%dHz, Duty=%.2f%%\n", 
                  gui_pwm_frequency, gui_pwm_duty);
  }
  
  if (server.hasArg("stop")) {
    gui_pwm_active = false;
    analogWrite(GUI_PWM_PIN, 0);
    message = "PWM durduruldu";
  }
  
  if (server.hasArg("frequency")) {
    int freq = server.arg("frequency").toInt();
    if (freq >= 1 && freq <= 1000) {
      gui_pwm_frequency = freq;
      updatePWM = true;
      message = "Frekans gÃ¼ncellendi: " + String(freq) + " Hz";
    }
  }
  
  if (server.hasArg("duty")) {
    float duty = server.arg("duty").toFloat();
    Serial.printf("Web'den gelen duty deÄŸeri: %.2f\n", duty);
    if (duty >= 0.0 && duty <= 100.0) {
      gui_pwm_duty = duty;
      updatePWM = true;
      message = "Duty cycle gÃ¼ncellendi: " + String(duty) + "%";
      Serial.printf("gui_pwm_duty deÄŸiÅŸkeni gÃ¼ncellendi: %.2f%%\n", gui_pwm_duty);
    } else {
      message = "Hata: Duty cycle 0-100 arasÄ±nda olmalÄ±!";
      Serial.printf("GeÃ§ersiz duty deÄŸeri: %.2f\n", duty);
    }
  }
  
  if (updatePWM && gui_pwm_active) {
    analogWriteFreq(gui_pwm_frequency);
    int pwmValue = (int)((gui_pwm_duty * GUI_PWM_RANGE) / 100.0);
    analogWrite(GUI_PWM_PIN, pwmValue);
    Serial.printf("PWM gÃ¼ncellendi - Frekans: %dHz, Duty: %.2f%%, PWM DeÄŸer: %d/%d\n", 
                  gui_pwm_frequency, gui_pwm_duty, pwmValue, GUI_PWM_RANGE);
  }
  
  server.send(200, "text/plain", message);
}

void initWebServer() {
  // Web sunucu rotalarÄ±nÄ± tanÄ±mla
  server.on("/", handleRoot);
  server.on("/style.css", handleCSS);
  server.on("/script.js", handleJS);
  server.on("/data", handleSensorData);
  server.on("/pwm", handlePWMControl);
  server.onNotFound(handleNotFound);
  
  // Sunucuyu baÅŸlat
  server.begin();
  webServerActive = true;
  Serial.println("âœ“ Web sunucu baÅŸlatÄ±ldÄ±");
  Serial.print("Web arayÃ¼zÃ¼: http://");
  Serial.println(WiFi.localIP());
}

void setup() {
  Serial.begin(115200);
  delay(2000); // Daha uzun baÅŸlangÄ±Ã§ bekleme sÃ¼resi
  
  Serial.println("\n=== ESP8266 NodeMCU I2C SENSÃ–R SISTEMI ===");
  Serial.println("BaÅŸlatÄ±lÄ±yor...\n");
  
  // Dosya sistemini baÅŸlat
  initFileSystem();
  
  // I2C baÅŸlat - sabit hÄ±z ayarÄ±
  Wire.begin(SDA_PIN, SCL_PIN);
  Wire.setClock(100000); // Sabit 100kHz hÄ±z
  delay(1000);
  
  Serial.printf("I2C pinleri: SDA=D2(GPIO%d), SCL=D1(GPIO%d)\n", SDA_PIN, SCL_PIN);
  Serial.printf("GUI PWM pini: D5(GPIO%d)\n", GUI_PWM_PIN);
  Serial.println("I2C hÄ±z: 100kHz (sabit hÄ±z)");
  
  // I2C cihazlarÄ± tara
  scanI2CDevices();
  
  // MLX90614 (SÄ±caklÄ±k SensÃ¶rÃ¼) BaÅŸlatma
  Serial.println("=== MLX90614 SICAKLIK SENSÃ–RÃœ ===");
  mlx90614_ready = false;
  
  for (int attempt = 0; attempt < 3; attempt++) {
    Serial.printf("Deneme %d/3: ", attempt + 1);
    
    // I2C cihazÄ±nÄ± kontrol et
    if (!checkI2CDevice(0x5A, 3)) {
      Serial.println("âœ— I2C'de MLX90614 bulunamadÄ±");
      delay(1000);
      continue;
    }
    
    // SensÃ¶rÃ¼ baÅŸlat
    if (mlx90614.begin()) {
      Serial.print("BaÅŸlatÄ±ldÄ±, test ediliyor... ");
      delay(500);
      
      // Test okuma
      float testTemp = mlx90614.readAmbientTempC();
      if (!isnan(testTemp) && testTemp > -50 && testTemp < 100) {
        Serial.printf("âœ“ BAÅARILI! Test sÄ±caklÄ±k: %.2fÂ°C\n", testTemp);
        mlx90614_ready = true;
        break;
      } else {
        Serial.printf("âœ— GeÃ§ersiz okuma: %.2f\n", testTemp);
      }
    } else {
      Serial.println("âœ— BaÅŸlatma baÅŸarÄ±sÄ±z");
    }
    
    if (attempt < 2) {
      Serial.println("I2C yeniden baÅŸlatÄ±lÄ±yor...");
      restartI2C();
    }
  }
  
  if (!mlx90614_ready) {
    Serial.println("âš  MLX90614 baÅŸlatÄ±lamadÄ± - NULL deÄŸerler gÃ¶nderilecek");
  }
  
  delay(1000);
  
  // MLX90393 (Manyetik SensÃ¶r) BaÅŸlatma
  Serial.println("\n=== MLX90393 MANYETIK SENSÃ–R ===");
  mlx90393_ready = false;
  
  for (int attempt = 0; attempt < 3; attempt++) {
    Serial.printf("Deneme %d/3: ", attempt + 1);
    
    // I2C cihazÄ±nÄ± kontrol et
    if (!checkI2CDevice(0x18, 3)) {
      Serial.println("âœ— I2C'de MLX90393 bulunamadÄ±");
      delay(1000);
      continue;
    }
    
    // SensÃ¶rÃ¼ baÅŸlat
    if (mlx90393.begin_I2C(0x18)) {
      Serial.print("BaÅŸlatÄ±ldÄ±, ayarlanÄ±yor... ");
      
      // Konservatif ayarlar
      mlx90393.setGain(MLX90393_GAIN_2_5X); // Daha dÃ¼ÅŸÃ¼k gain
      mlx90393.setResolution(MLX90393_X, MLX90393_RES_16);
      mlx90393.setResolution(MLX90393_Y, MLX90393_RES_16);
      mlx90393.setResolution(MLX90393_Z, MLX90393_RES_16);
      mlx90393.setOversampling(MLX90393_OSR_1); // Daha yavaÅŸ
      // Filtre kaldÄ±rÄ±ldÄ±
      
      delay(500);
      
      // Test okuma
      float x, y, z;
      if (mlx90393.readData(&x, &y, &z)) {
        float magnitude = sqrt(x*x + y*y + z*z) / UT_TO_MT;
        Serial.printf("âœ“ BAÅARILI! Manyetik alan: %.3fmT\n", magnitude);
        mlx90393_ready = true;
        break;
      } else {
        Serial.println("âœ— Test okuma baÅŸarÄ±sÄ±z");
      }
    } else {
      Serial.println("âœ— BaÅŸlatma baÅŸarÄ±sÄ±z");
    }
    
    if (attempt < 2) {
      Serial.println("I2C yeniden baÅŸlatÄ±lÄ±yor...");
      restartI2C();
    }
  }
  
  if (!mlx90393_ready) {
    Serial.println("âš  MLX90393 baÅŸlatÄ±lamadÄ±");
  }
  
  // I2C hÄ±zÄ± zaten 100kHz olarak ayarlandÄ±
  delay(200);
  Serial.println("\nI2C hÄ±z 100kHz olarak sabit ayarlandÄ±");
  
  // GUI ile uyumlu PWM pin ayarlarÄ±
   pinMode(GUI_PWM_PIN, OUTPUT);
   digitalWrite(GUI_PWM_PIN, LOW);
   Serial.println("GUI ile uyumlu Ã§alÄ±ÅŸma modu aktif");
   Serial.printf("GUI PWM Pini: D5 (GPIO%d)\n", GUI_PWM_PIN);
  
  // WiFi baÄŸlantÄ±sÄ± - sÃ¼rekli tekrar deneme mekanizmasÄ±
  Serial.println("\n=== WiFi BAÄLANTI SISTEMI ===");
  Serial.printf("SSID: %s\n", WIFI_SSID);
  Serial.println("WiFi baÄŸlantÄ±sÄ± kuruluyor...");
  
  Serial.println("Sabit IP adresi yapÄ±landÄ±rÄ±lÄ±yor: 192.168.244.200");
  WiFi.config(staticIP, gateway, subnet, dns);
  
  // WiFi baÄŸlantÄ±sÄ± kurulana kadar sÃ¼rekli dene
  while (WiFi.status() != WL_CONNECTED) {
    WiFi.begin(WIFI_SSID, WIFI_PSWD);
    Serial.print("BaÄŸlanÄ±yor");
    
    // 15 saniye boyunca baÄŸlantÄ± kontrolÃ¼ (ESP8266 daha yavaÅŸ)
    for (int i = 0; i < 15; i++) {
      delay(1000);
      Serial.print(".");
      
      if (WiFi.status() == WL_CONNECTED) {
        break;
      }
    }
    
    if (WiFi.status() == WL_CONNECTED) {
      Serial.println("\nâœ“ WiFi baÄŸlandÄ±!");
      Serial.printf("IP Adresi: %s\n", WiFi.localIP().toString().c_str());
      Serial.printf("Sinyal GÃ¼cÃ¼: %d dBm\n", WiFi.RSSI());
      
      // UDP portlarÄ±nÄ± baÅŸlat
      udpSensor.begin(sensorPort);  // SensÃ¶r verilerini gÃ¶ndermek iÃ§in
      udpPWM.begin(pwmPort);        // PWM komutlarÄ±nÄ± almak iÃ§in
      Serial.printf("UDP SensÃ¶r Port %d'de baÅŸlatÄ±ldÄ±\n", sensorPort);
      Serial.printf("UDP PWM Port %d'de dinleniyor\n", pwmPort);
      Serial.printf("SensÃ¶r veri gÃ¶nderim: %s:%d (doÄŸrudan baÄŸlantÄ±)\n\n", guiIP, sensorPort);
      
      // Web sunucuyu baÅŸlat
      initWebServer();
      break;
    } else {
      Serial.println("\nâœ— BaÄŸlantÄ± baÅŸarÄ±sÄ±z! 2 saniye sonra tekrar denenecek...");
      WiFi.disconnect();
      delay(2000);
    }
  }
  
  // Manyetik buffer sÄ±fÄ±rlama kodu kaldÄ±rÄ±ldÄ± - filtreleme yapÄ±lmÄ±yor
  
  lastReport = millis();
  
  // OTA baÅŸlat
  Serial.println("\n=== OTA GÃœNCELLEME SISTEMI ===\n");
  ArduinoOTA.setHostname("ESP8266_COIL");  // Arduino IDE'de gÃ¶receÄŸin isim
  
  // OTA olaylarÄ±nÄ± izleme
  ArduinoOTA.onStart([]() {
    String type;
    if (ArduinoOTA.getCommand() == U_FLASH) {
      type = "sketch";
    } else { // U_FS
      type = "filesystem";
    }
    Serial.println("OTA BaÅŸlÄ±yor: " + type);
  });
  
  ArduinoOTA.onEnd([]() {
    Serial.println("\nâœ“ OTA TamamlandÄ±!");
  });
  
  ArduinoOTA.onProgress([](unsigned int progress, unsigned int total) {
    Serial.printf("Ä°lerleme: %u%%\r", (progress / (total / 100)));
  });
  
  ArduinoOTA.onError([](ota_error_t error) {
    Serial.printf("OTA Hata[%u]: ", error);
    if (error == OTA_AUTH_ERROR) {
      Serial.println("Yetkilendirme HatasÄ±");
    } else if (error == OTA_BEGIN_ERROR) {
      Serial.println("BaÅŸlangÄ±Ã§ HatasÄ±");
    } else if (error == OTA_CONNECT_ERROR) {
      Serial.println("BaÄŸlantÄ± HatasÄ±");
    } else if (error == OTA_RECEIVE_ERROR) {
      Serial.println("Veri Alma HatasÄ±");
    } else if (error == OTA_END_ERROR) {
      Serial.println("SonlandÄ±rma HatasÄ±");
    }
  });
  
  ArduinoOTA.begin();
  Serial.println("âœ“ OTA HazÄ±r! IP: " + WiFi.localIP().toString());
  Serial.println("Arduino IDE'de AraÃ§lar > Port menÃ¼sÃ¼nden aÄŸ portunu seÃ§in");
  Serial.println("============================\n");
  
  // Final durum raporu
  Serial.println("=== SISTEM DURUM RAPORU ===");
  Serial.printf("MLX90393 (Manyetik): %s\n", mlx90393_ready ? "âœ“ HAZIR" : "âœ— BAÄLI DEÄIL");
  Serial.printf("MLX90614 (SÄ±caklÄ±k): %s\n", mlx90614_ready ? "âœ“ HAZIR" : "âœ— BAÄLI DEÄIL");
  Serial.printf("WiFi: %s\n", WiFi.status() == WL_CONNECTED ? "âœ“ BAÄLI" : "âœ— BAÄLI DEÄIL");
  Serial.printf("OTA: %s\n", WiFi.status() == WL_CONNECTED ? "âœ“ HAZIR" : "âœ— BAÄLI DEÄIL");
  Serial.println("============================\n");
  
  if (mlx90393_ready || mlx90614_ready) {
    Serial.println("âœ“ Sistem hazÄ±r! ESP8266 optimize ayarlar:");
    Serial.println("- Manyetik okuma: 40Hz");
    Serial.println("- SÄ±caklÄ±k okuma: 2Hz");
    Serial.println("- UDP gÃ¶nderim: 100Hz");
  } else {
    Serial.println("âš  HiÃ§bir sensÃ¶r Ã§alÄ±ÅŸmÄ±yor - sadece PWM kontrol aktif");
  }
}

// Filtreleme fonksiyonlarÄ± kaldÄ±rÄ±ldÄ± - doÄŸrudan Ã¶lÃ§Ã¼m deÄŸerleri kullanÄ±lacak

void readMagneticField() {
  if (!mlx90393_ready) return;
  
  float x_ut, y_ut, z_ut;
  
  // Optimize edilmiÅŸ okuma - tek deneme ile hÄ±zlÄ± okuma
  if (mlx90393.readData(&x_ut, &y_ut, &z_ut)) {
    // DoÄŸrudan hesaplama - ara deÄŸiÅŸkenler olmadan
    cached_magnetic_magnitude = sqrt(
      (x_ut / UT_TO_MT) * (x_ut / UT_TO_MT) + 
      (y_ut / UT_TO_MT) * (y_ut / UT_TO_MT) + 
      (z_ut / UT_TO_MT) * (z_ut / UT_TO_MT)
    );
    return; // BaÅŸarÄ±lÄ± okuma
  }
  
  // Sadece bir kez daha dene - daha kÄ±sa bekleme ile
  delay(5); // Minimal bekleme
  if (mlx90393.readData(&x_ut, &y_ut, &z_ut)) {
    cached_magnetic_magnitude = sqrt(
      (x_ut / UT_TO_MT) * (x_ut / UT_TO_MT) + 
      (y_ut / UT_TO_MT) * (y_ut / UT_TO_MT) + 
      (z_ut / UT_TO_MT) * (z_ut / UT_TO_MT)
    );
    return;
  }
  
  failedReads++;
}

void readTemperature() {
  if (!mlx90614_ready) {
    cached_ambient_temp = -999.0;
    cached_object_temp = -999.0;
    return;
  }
  
  // Ultra optimize edilmiÅŸ okuma - minimum gecikme
  float ambient = mlx90614.readAmbientTempC();
  float object = mlx90614.readObjectTempC();
  
  // HÄ±zlÄ± veri doÄŸrulama
  if (!isnan(ambient) && !isnan(object) && 
      ambient > -50 && ambient < 100 && 
      object > -50 && object < 200) {
    cached_ambient_temp = ambient;
    cached_object_temp = object;
    return; // BaÅŸarÄ±lÄ± okuma
  }
  
  // Tek retry ile ultra hÄ±zlÄ± hata kurtarma - minimum gecikme
  delay(5);
  ambient = mlx90614.readAmbientTempC();
  object = mlx90614.readObjectTempC();
  
  // Son kontrol
  if (!isnan(ambient) && !isnan(object) && 
      ambient > -50 && ambient < 100 && 
      object > -50 && object < 200) {
    cached_ambient_temp = ambient;
    cached_object_temp = object;
    return;
  }
  
  // BaÅŸarÄ±sÄ±z okuma
  cached_ambient_temp = -999.0;
  cached_object_temp = -999.0;
  failedReads++;
}

void sendUDPData() {
  // HÄ±zlÄ± WiFi kontrolÃ¼ - baÄŸlantÄ± yoksa gÃ¶nderme
  if (WiFi.status() != WL_CONNECTED) {
    return;
  }
  
  // JSON belgesini temizle ve minimum gerekli verileri ekle
  doc.clear();
  doc["timestamp"] = millis();
  doc["coil_id"] = COIL_ID;
  doc["magnetic_magnitude"] = round(cached_magnetic_magnitude * 1000) / 1000.0;
  
  // SÄ±caklÄ±k verilerini optimize edilmiÅŸ ÅŸekilde ekle
  if (cached_ambient_temp != -999.0) {
    doc["ambient_temp"] = round(cached_ambient_temp * 100) / 100.0;
  } else {
    doc["ambient_temp"] = nullptr;
  }
  
  if (cached_object_temp != -999.0) {
    doc["object_temp"] = round(cached_object_temp * 100) / 100.0;
  } else {
    doc["object_temp"] = nullptr;
  }
  
  // GUI ile uyumlu veri gÃ¶nderimi - sadece gerekli bilgileri ekle
  doc["gui_pwm_active"] = gui_pwm_active;
  doc["gui_pwm_frequency"] = gui_pwm_frequency;
  doc["gui_pwm_duty"] = gui_pwm_duty;
  
  // WiFi performans bilgilerini ekle - gerÃ§ek zamanlÄ± performans iÃ§in kritik
  doc["wifi_rssi"] = wifiStrength;
  doc["udp_interval"] = udpInterval;
  
  // JSON'Ä± hÄ±zlÄ±ca serileÅŸtir
  size_t len = serializeJson(doc, jsonBuffer);
  
  // Debug Ã§Ä±ktÄ±larÄ±nÄ± kaldÄ±rarak performansÄ± artÄ±r
  // Serial.printf("[DEBUG] Sending sensor data to %s:%d\n", guiIP, sensorPort);
  // Serial.printf("[DEBUG] JSON: %s\n", jsonBuffer);
  
  // UDP paket gÃ¶nderimi - optimize edilmiÅŸ
  udpSensor.beginPacket(guiIP, sensorPort);
  udpSensor.write((uint8_t*)jsonBuffer, len);
  bool success = udpSensor.endPacket();
  
  // Debug Ã§Ä±ktÄ±larÄ±nÄ± kaldÄ±rarak performansÄ± artÄ±r
  // if (success) {
  //   Serial.printf("[DEBUG] UDP packet sent successfully (%d bytes)\n", len);
  // } else {
  //   Serial.println("[DEBUG] UDP packet send failed!");
  // }
  
  // Ä°statistik gÃ¼ncelleme
  packetCount++;
  totalBytes += len;
}

void processUDPCommands() {
  int packetSize = udpPWM.parsePacket();
  if (packetSize) {
    char packetBuffer[255];
    int len = udpPWM.read(packetBuffer, 255);
    if (len > 0) {
      packetBuffer[len] = 0;
      
      StaticJsonDocument<200> cmdDoc;
      DeserializationError error = deserializeJson(cmdDoc, packetBuffer);
      if (error == DeserializationError::Ok) {
        // GUI'den komut alÄ±ndÄ±
        Serial.println("GUI'den komut alÄ±ndÄ±");
        Serial.println(packetBuffer);
        
        // Komutun hangi coil_id iÃ§in olduÄŸunu kontrol et
        if (cmdDoc.containsKey("coil_id")) {
          int targetCoilId = cmdDoc["coil_id"];
          
          // Bu ESP32'nin COIL_ID'si ile eÅŸleÅŸmiyorsa komutu iÅŸleme
          if (targetCoilId != COIL_ID) {
            Serial.printf("Bu komut Coil ID %d iÃ§in, bu cihaz Coil ID %d. Komut yok sayÄ±lÄ±yor.\n", 
                         targetCoilId, COIL_ID);
            return;
          }
          
          Serial.printf("Bu cihaz iÃ§in komut alÄ±ndÄ± (Coil ID %d)\n", COIL_ID);
        } else {
          // coil_id belirtilmemiÅŸse, eski komut formatÄ± olabilir, iÅŸlemeye devam et
          Serial.println("UyarÄ±: Komutta coil_id belirtilmemiÅŸ, tÃ¼m cihazlar iÅŸleyecek");
        }
         
        // PWM baÅŸlatma komutu (hem gui_pwm_start hem de pwm_start formatÄ±nÄ± destekle)
        if (cmdDoc["gui_pwm_start"] == true || cmdDoc["pwm_start"] == true) {
          Serial.printf("UDP PWM baÅŸlatma komutu alÄ±ndÄ± - Mevcut duty: %.2f%%\n", gui_pwm_duty);
          if (!gui_pwm_active) {
            analogWriteFreq(gui_pwm_frequency);
            int pwmValue = (int)((gui_pwm_duty * GUI_PWM_RANGE) / 100.0);
            analogWrite(GUI_PWM_PIN, pwmValue);
            gui_pwm_active = true;
            Serial.printf("PWM baÅŸlatÄ±ldÄ± - Frekans: %dHz, Duty: %.2f%% (PWM DeÄŸer: %d/%d)\n", 
                        gui_pwm_frequency, gui_pwm_duty, pwmValue, GUI_PWM_RANGE);
          } else {
            Serial.println("PWM zaten Ã§alÄ±ÅŸÄ±yor");
          }
        }
         
        // PWM durdurma komutu (hem gui_pwm_stop hem de pwm_stop formatÄ±nÄ± destekle)
        else if (cmdDoc["gui_pwm_stop"] == true || cmdDoc["pwm_stop"] == true) {
          if (gui_pwm_active) {
            analogWrite(GUI_PWM_PIN, 0);
            gui_pwm_active = false;
            Serial.println("PWM durduruldu");
          }
        }
         
        // PWM frekans ayarÄ± (hem gui_pwm_frequency hem de pwm_freq formatÄ±nÄ± destekle)
        if (cmdDoc["gui_pwm_frequency"].is<int>() || cmdDoc["pwm_freq"].is<int>()) {
          int freq = 0;
          if (cmdDoc["gui_pwm_frequency"].is<int>()) {
            freq = cmdDoc["gui_pwm_frequency"];
          } else if (cmdDoc["pwm_freq"].is<int>()) {
            freq = cmdDoc["pwm_freq"];
          }
          
          if (freq >= 1 && freq <= 1000) {  // ESP8266 PWM frekans sÄ±nÄ±rÄ±
            gui_pwm_frequency = freq;
            if (gui_pwm_active) {
              analogWriteFreq(gui_pwm_frequency);
              int pwmValue = (int)((gui_pwm_duty * GUI_PWM_RANGE) / 100.0);
              analogWrite(GUI_PWM_PIN, pwmValue);
              Serial.printf("PWM Frekans gÃ¼ncellendi: %d Hz (Duty: %.1f%%, PWM DeÄŸer: %d/%d)\n", 
                          freq, gui_pwm_duty, pwmValue, GUI_PWM_RANGE);
            } else {
              Serial.printf("PWM Frekans ayarlandÄ±: %d Hz (PWM baÅŸlatÄ±ldÄ±ÄŸÄ±nda uygulanacak)\n", freq);
            }
          } else {
            Serial.printf("GeÃ§ersiz frekans: %dHz. 1-1000Hz arasÄ±nda olmalÄ±.\n", freq);
          }
        }
         
        // PWM duty cycle ayarÄ± (hem gui_pwm_duty hem de pwm_duty formatÄ±nÄ± destekle)
        if (cmdDoc["gui_pwm_duty"].is<float>() || cmdDoc["pwm_duty"].is<float>() || 
            cmdDoc["gui_pwm_duty"].is<int>() || cmdDoc["pwm_duty"].is<int>()) {
          float duty = 0.0;
          
          // Float veya int olarak gelen duty deÄŸerini al
          if (cmdDoc["gui_pwm_duty"].is<float>()) {
            duty = cmdDoc["gui_pwm_duty"].as<float>();
          } else if (cmdDoc["gui_pwm_duty"].is<int>()) {
            duty = (float)cmdDoc["gui_pwm_duty"].as<int>();
          } else if (cmdDoc["pwm_duty"].is<float>()) {
            duty = cmdDoc["pwm_duty"].as<float>();
          } else if (cmdDoc["pwm_duty"].is<int>()) {
            duty = (float)cmdDoc["pwm_duty"].as<int>();
          }
          
          // Duty deÄŸerini sÄ±nÄ±rla (gereksiz bÃ¶lme iÅŸlemi kaldÄ±rÄ±ldÄ±)
          if (duty >= 0.0 && duty <= 100.0) {
            gui_pwm_duty = duty;
            if (gui_pwm_active) {
              int pwmValue = (int)((duty * GUI_PWM_RANGE) / 100.0);
              analogWrite(GUI_PWM_PIN, pwmValue);
              Serial.printf("PWM Duty: %.1f%% (PWM DeÄŸer: %d/%d)\n", duty, pwmValue, GUI_PWM_RANGE);
            } else {
              Serial.printf("PWM Duty ayarlandÄ±: %.1f%% (PWM baÅŸlatÄ±ldÄ±ÄŸÄ±nda uygulanacak)\n", duty);
            }
          } else {
            Serial.printf("GeÃ§ersiz duty cycle: %.1f%%. 0-100 arasÄ±nda olmalÄ±.\n", duty);
          }
        }
         
        // PWM durum kontrolÃ¼ (hem check_gui_pwm hem de check_pwm formatÄ±nÄ± destekle)
        if (cmdDoc["check_gui_pwm"] == true || cmdDoc["check_pwm"] == true) {
          Serial.println("\n=== PWM DURUM KONTROLÃœ ===\n");
          Serial.printf("PWM Durumu: %s\n", gui_pwm_active ? "âœ“ Ã‡ALIÅIYOR" : "âœ— DURDURULDU");
          Serial.printf("PWM Aktif: %s\n", gui_pwm_active ? "Evet" : "HayÄ±r");
          Serial.printf("Frekans: %d Hz\n", gui_pwm_frequency);
          Serial.printf("Duty Cycle: %.1f%%\n", gui_pwm_duty);
          if (gui_pwm_active) {
            int expectedPwmValue = (int)((gui_pwm_duty * GUI_PWM_RANGE) / 100.0);
            Serial.printf("PWM DeÄŸeri: %d/%d\n", expectedPwmValue, GUI_PWM_RANGE);
            Serial.printf("Ã‡Ä±kÄ±ÅŸ VoltajÄ±: %.2fV\n", (3.3 * gui_pwm_duty / 100.0));
          }
          Serial.println("============================\n");
        }
        
        // UDP aralÄ±ÄŸÄ± bilgisi (sadece bilgi amaÃ§lÄ±)
        if (cmdDoc["udp_interval"].is<int>()) {
          int interval = cmdDoc["udp_interval"];
          if (interval >= 50 && interval <= 2000) {
            Serial.printf("UDP aralÄ±ÄŸÄ± bilgisi alÄ±ndÄ±: %dms (sabit 25ms kullanÄ±lÄ±yor)\n", interval);
          }
        }
        
        if (cmdDoc["check_sensors"] == true) {
          Serial.println("\n=== SENSÃ–R DURUM KONTROLÃœ ===\n");
          Serial.printf("MLX90393 (Manyetik): %s\n", mlx90393_ready ? "âœ“ Ã‡ALIÅIYOR" : "âœ— BAÄLI DEÄIL");
          Serial.printf("MLX90614 (SÄ±caklÄ±k): %s\n", mlx90614_ready ? "âœ“ Ã‡ALIÅIYOR" : "âœ— BAÄLI DEÄIL");
          if (mlx90614_ready) {
            Serial.printf("Son sÄ±caklÄ±k: %.1fÂ°C / %.1fÂ°C\n", cached_ambient_temp, cached_object_temp);
          }
          if (mlx90393_ready) {
            Serial.printf("Son manyetik alan: %.3fmT\n", cached_magnetic_magnitude);
          }
          Serial.println("===============================\n");
        }
        
        if (cmdDoc["restart_i2c"] == true) {
          Serial.println("I2C yeniden baÅŸlatÄ±lÄ±yor...");
          restartI2C();
          scanI2CDevices();
        }
      }
    }
  }
}

// WiFi sinyal gÃ¼cÃ¼ Ã¶lÃ§Ã¼mÃ¼
void updateWiFiStrength() {
  // WiFi sinyal gÃ¼cÃ¼nÃ¼ Ã¶lÃ§
  wifiStrength = WiFi.RSSI();
  
  // Sinyal gÃ¼cÃ¼nÃ¼ raporla
  if (wifiStrength > -50) {
    Serial.println("[WiFi] MÃ¼kemmel sinyal gÃ¼cÃ¼");
  } else if (wifiStrength > -60) {
    Serial.println("[WiFi] Ä°yi sinyal gÃ¼cÃ¼");
  } else if (wifiStrength > -70) {
    Serial.println("[WiFi] Orta sinyal gÃ¼cÃ¼");
  } else if (wifiStrength > -80) {
    Serial.println("[WiFi] ZayÄ±f sinyal gÃ¼cÃ¼");
  } else {
    Serial.println("[WiFi] Ã‡ok zayÄ±f sinyal gÃ¼cÃ¼");
  }
}

void printPerformanceStats() {
  unsigned long now = millis();
  if (now - lastReport >= 5000) { // 5 saniye rapor
    Serial.printf("\n--- PERFORMANS RAPORU ---\n");
    Serial.printf("UDP: %.1f paket/5s, %.0f byte/5s\n", (float)packetCount, (float)totalBytes);
    Serial.printf("BaÅŸarÄ±sÄ±z okuma: %lu\n", failedReads);
    
    Serial.printf("WiFi: %s (Sinyal: %ddBm)\n", 
                  WiFi.status() == WL_CONNECTED ? "BaÄŸlÄ±" : "BaÄŸlÄ± DeÄŸil", wifiStrength);
    Serial.printf("UDP AralÄ±ÄŸÄ±: %lums (sabit)\n", udpInterval);
    
    if (mlx90393_ready) {
      Serial.printf("Manyetik: %.3fmT\n", cached_magnetic_magnitude);
    } else {
      Serial.println("Manyetik: SensÃ¶r Yok");
    }
    
    if (mlx90614_ready) {
      Serial.printf("SÄ±caklÄ±k: %.1fÂ°C / %.1fÂ°C\n", cached_ambient_temp, cached_object_temp);
    } else {
      Serial.println("SÄ±caklÄ±k: SensÃ¶r Yok");
    }
    
    // ESP8266 bellek durumu
    Serial.printf("Serbest Heap: %u bytes\n", ESP.getFreeHeap());
    
    Serial.println("------------------------\n");
    
    packetCount = 0;
    totalBytes = 0;
    lastReport = now;
  }
}

void loop() {
  // OTA gÃ¼ncellemelerini kontrol et
  ArduinoOTA.handle();
  
  // Web sunucuyu iÅŸle
  if (webServerActive) {
    server.handleClient();
  }
  
  unsigned long currentTime = millis();
  
  // WiFi baÄŸlantÄ± kontrolÃ¼ - daha az sÄ±klÄ±kta
  static unsigned long lastWiFiCheck = 0;
  if (currentTime - lastWiFiCheck >= 5000) { // Her 5 saniyede kontrol et - daha az sÄ±klÄ±kta
    lastWiFiCheck = currentTime;
    
    if (WiFi.status() != WL_CONNECTED) {
      // Sessiz yeniden baÄŸlanma - debug Ã§Ä±ktÄ±larÄ± kaldÄ±rÄ±ldÄ±
      WiFi.disconnect();
      
      // Sabit IP adresini yeniden yapÄ±landÄ±r
      WiFi.config(staticIP, gateway, subnet, dns);
      
      WiFi.begin(WIFI_SSID, WIFI_PSWD);
    }
  }
  
  // UDP komutlarÄ±nÄ± iÅŸle - her dÃ¶ngÃ¼de kontrol et
  processUDPCommands();
  
  // WiFi sinyal gÃ¼cÃ¼nÃ¼ gÃ¼ncelle - daha az sÄ±klÄ±kta
  if (currentTime - lastReport >= 5000) {
    wifiStrength = WiFi.RSSI(); // Sessiz gÃ¼ncelleme
  }
  
  // Manyetik alan Ã¶lÃ§Ã¼mÃ¼ - 40Hz (25ms) - GerÃ§ek zamanlÄ± performans iÃ§in optimize
  if (currentTime - lastSensorRead >= magneticInterval) {
    lastSensorRead = currentTime;
    readMagneticField(); // Debug Ã§Ä±ktÄ±larÄ± kaldÄ±rÄ±ldÄ±
  }
  
  // SÄ±caklÄ±k Ã¶lÃ§Ã¼mÃ¼ - 2Hz (500ms) - DeÄŸiÅŸim hÄ±zÄ± dÃ¼ÅŸÃ¼k
  if (currentTime - lastTempRead >= tempInterval) {
    lastTempRead = currentTime;
    readTemperature(); // Debug Ã§Ä±ktÄ±larÄ± kaldÄ±rÄ±ldÄ±
  }
  
  // UDP veri gÃ¶nderimi - 100Hz (10ms) - GerÃ§ek zamanlÄ± performans iÃ§in optimize
  if (currentTime - lastUDPSend >= udpInterval) {
    lastUDPSend = currentTime;
    sendUDPData(); // Debug Ã§Ä±ktÄ±larÄ± kaldÄ±rÄ±ldÄ±
  }
  
  // Performans istatistiklerini sadece gerektiÄŸinde yazdÄ±r
  if (currentTime - lastReport >= 5000) {
    printPerformanceStats();
  }
  
  // ESP8266 iÃ§in yield() Ã§aÄŸrÄ±sÄ± - WDT reset'i Ã¶nlemek iÃ§in
  yield();
  
  // Gecikme kaldÄ±rÄ±ldÄ± - maksimum yanÄ±tÂ hÄ±zÄ±Â iÃ§in
}